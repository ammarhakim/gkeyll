name: Linux Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  build:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2- 
    - name: Install gfortran
      run: sudo apt-get install -y gfortran
    - name: install-openblas
      run: sudo apt-get install libopenblas-dev
    - name: where-openblas
      run: dpkg -L libopenblas-pthread-dev
    - name: install-lapacke
      run: sudo apt-get install liblapacke-dev
    - name: where-liblapacke-dev
      run: dpkg -L liblapacke-dev    
    - name: install-deps
      run: cd install-deps; ./mkdeps.sh --build-superlu=yes; cd ..
    - name: make (with retry)
      run: |
        set +e
        attempt=1
        until make CC=clang -j LAPACK_INC=/usr/include/x86_64-linux-gnu/openblas-pthread \
          LAPACK_LIB="/usr/lib/x86_64-linux-gnu/liblapacke.a /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblas.a /usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.a -lgfortran" -j; do
          if [ $attempt -ge 2 ]; then
            echo "Make failed after 2 attempts."
            exit 1
          fi
          echo "Retrying make... (Attempt $((attempt+1)))"
          attempt=$((attempt+1))
          sleep 2
        done
        set -e
    - name: make check
      run: make CC=clang check -j LAPACK_INC=/usr/include/x86_64-linux-gnu/openblas-pthread LAPACK_LIB="/usr/lib/x86_64-linux-gnu/liblapacke.a -lgfortran"
    - name: make regression
      run: make CC=clang regression -j LAPACK_INC=/usr/include/x86_64-linux-gnu/openblas-pthread LAPACK_LIB="/usr/lib/x86_64-linux-gnu/liblapacke.a -lgfortran"